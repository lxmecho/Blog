---
import { siteConfig } from '../config/site';
---

<div class="relative">
  <button id="color-palette-button" class="p-1.5 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
    </svg>
  </button>
  
  <!-- 颜色主题下拉面板 -->
  <div id="color-palette-panel" class="hidden absolute right-0 mt-2 w-40 bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden z-50">
    <div class="p-2">
      <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-2 px-2">主题颜色</h3>
      <div class="space-y-1">
        {siteConfig.appearance.themeColors.map((color) => (
          <button 
            class="color-theme-option flex items-center w-full px-2 py-1.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded"
            data-color={color.primaryColor}
            data-name={color.name}
          >
            <span class="w-4 h-4 rounded-full mr-2" style={`background-color: ${color.primaryColor}`}></span>
            <span>{color.name}</span>
          </button>
        ))}
      </div>
    </div>
  </div>
</div>

<script>
  // 确保代码在DOMContentLoaded事件之后执行
  document.addEventListener('DOMContentLoaded', () => {
    // 获取DOM元素
    const colorPaletteButton = document.getElementById('color-palette-button');
    const colorPalettePanel = document.getElementById('color-palette-panel');
    const colorThemeOptions = document.querySelectorAll('.color-theme-option');
    
    // 设置CSS变量函数
    function setThemeColor(colorHex) {
      // 将十六进制颜色转换为RGB值
      const r = parseInt(colorHex.slice(1, 3), 16);
      const g = parseInt(colorHex.slice(3, 5), 16);
      const b = parseInt(colorHex.slice(5, 7), 16);
      
      // 设置CSS变量
      document.documentElement.style.setProperty('--color-primary', colorHex);
      document.documentElement.style.setProperty('--color-primary-rgb', `${r}, ${g}, ${b}`);
      
      // 创建一个颜色更新事件，通知其他组件
      const event = new CustomEvent('themeColorChanged', { 
        detail: { color: colorHex, rgb: `${r}, ${g}, ${b}` } 
      });
      document.dispatchEvent(event);
      
      // 保存到localStorage
      localStorage.setItem('theme-color', colorHex);
      
      // 强制刷新以确保所有颜色都被更新
      document.body.classList.add('color-theme-updated');
      setTimeout(() => {
        document.body.classList.remove('color-theme-updated');
      }, 100);
    }
    
    // 面板切换
    if (colorPaletteButton && colorPalettePanel) {
      colorPaletteButton.addEventListener('click', (event) => {
        event.stopPropagation(); // 阻止事件冒泡
        colorPalettePanel.classList.toggle('hidden');
      });
      
      // 点击面板内部不关闭面板
      colorPalettePanel.addEventListener('click', (event) => {
        event.stopPropagation();
      });
    }
    
    // 点击其他区域关闭面板
    document.addEventListener('click', () => {
      if (colorPalettePanel && !colorPalettePanel.classList.contains('hidden')) {
        colorPalettePanel.classList.add('hidden');
      }
    });
    
    // 颜色主题切换
    colorThemeOptions.forEach(option => {
      if (option) {
        option.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          const color = option.getAttribute('data-color');
          if (color) {
            console.log('选择了颜色:', color); // 调试日志
            setThemeColor(color);
            if (colorPalettePanel) {
              colorPalettePanel.classList.add('hidden');
            }
          }
        });
      }
    });
    
    // 立即应用保存的颜色
    const savedColor = localStorage.getItem('theme-color');
    if (savedColor) {
      setThemeColor(savedColor);
    } else {
      // 获取默认颜色
      const firstColorOption = document.querySelector('.color-theme-option');
      if (firstColorOption) {
        const defaultColor = firstColorOption.getAttribute('data-color');
        if (defaultColor) {
          setThemeColor(defaultColor);
        }
      }
    }
  });
</script>

<style is:global>
  :root {
    --color-primary: #0ea5e9;
    --color-primary-rgb: 14, 165, 233;
  }
  
  /* 强制触发重新渲染 */
  .color-theme-updated * {
    transition: background-color 0.1s, color 0.1s, border-color 0.1s !important;
  }
  
  /* 主色调 */
  .text-primary-50, .text-primary-100, .text-primary-200, .text-primary-300, 
  .text-primary-400, .text-primary-500, .text-primary-600, .text-primary-700, 
  .text-primary-800, .text-primary-900, .text-primary-950 {
    color: var(--color-primary) !important;
    opacity: var(--tw-text-opacity, 1);
  }
  
  .bg-primary-50, .bg-primary-100, .bg-primary-200, .bg-primary-300, 
  .bg-primary-400, .bg-primary-500, .bg-primary-600, .bg-primary-700, 
  .bg-primary-800, .bg-primary-900, .bg-primary-950 {
    background-color: var(--color-primary) !important;
    opacity: var(--tw-bg-opacity, 1);
  }
  
  .border-primary-50, .border-primary-100, .border-primary-200, .border-primary-300, 
  .border-primary-400, .border-primary-500, .border-primary-600, .border-primary-700, 
  .border-primary-800, .border-primary-900, .border-primary-950 {
    border-color: var(--color-primary) !important;
    opacity: var(--tw-border-opacity, 1);
  }
  
  /* 悬停状态 */
  .hover\:text-primary-50:hover, .hover\:text-primary-100:hover, .hover\:text-primary-200:hover,
  .hover\:text-primary-300:hover, .hover\:text-primary-400:hover, .hover\:text-primary-500:hover,
  .hover\:text-primary-600:hover, .hover\:text-primary-700:hover, .hover\:text-primary-800:hover,
  .hover\:text-primary-900:hover, .hover\:text-primary-950:hover {
    color: var(--color-primary) !important;
  }
  
  .hover\:bg-primary-50:hover, .hover\:bg-primary-100:hover, .hover\:bg-primary-200:hover,
  .hover\:bg-primary-300:hover, .hover\:bg-primary-400:hover, .hover\:bg-primary-500:hover,
  .hover\:bg-primary-600:hover, .hover\:bg-primary-700:hover, .hover\:bg-primary-800:hover,
  .hover\:bg-primary-900:hover, .hover\:bg-primary-950:hover {
    background-color: var(--color-primary) !important;
  }
  
  .hover\:border-primary-50:hover, .hover\:border-primary-100:hover, .hover\:border-primary-200:hover,
  .hover\:border-primary-300:hover, .hover\:border-primary-400:hover, .hover\:border-primary-500:hover,
  .hover\:border-primary-600:hover, .hover\:border-primary-700:hover, .hover\:border-primary-800:hover,
  .hover\:border-primary-900:hover, .hover\:border-primary-950:hover {
    border-color: var(--color-primary) !important;
  }
  
  /* 焦点状态 */
  .focus\:ring-primary-50:focus, .focus\:ring-primary-100:focus, .focus\:ring-primary-200:focus,
  .focus\:ring-primary-300:focus, .focus\:ring-primary-400:focus, .focus\:ring-primary-500:focus,
  .focus\:ring-primary-600:focus, .focus\:ring-primary-700:focus, .focus\:ring-primary-800:focus,
  .focus\:ring-primary-900:focus, .focus\:ring-primary-950:focus {
    --tw-ring-color: var(--color-primary) !important;
  }
  
  .focus\:border-primary-50:focus, .focus\:border-primary-100:focus, .focus\:border-primary-200:focus,
  .focus\:border-primary-300:focus, .focus\:border-primary-400:focus, .focus\:border-primary-500:focus,
  .focus\:border-primary-600:focus, .focus\:border-primary-700:focus, .focus\:border-primary-800:focus,
  .focus\:border-primary-900:focus, .focus\:border-primary-950:focus {
    border-color: var(--color-primary) !important;
  }
</style> 