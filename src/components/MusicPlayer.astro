---
// 音乐播放器组件 - 在博客右上角添加音乐播放功能
---

<div id="music-player" class="relative">
  <button 
    id="music-toggle" 
    class="p-1.5 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-primary-500 dark:hover:text-primary-500 transition-colors"
    aria-label="播放/暂停音乐"
    title="播放/暂停音乐"
  >
    <!-- 播放图标 -->
    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    
    <!-- 暂停图标 (默认隐藏) -->
    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    
    <!-- 音乐播放动画 - 显示播放状态的小圆点 -->
    <div id="music-animation" class="absolute -top-1 -right-1 hidden">
      <span class="flex h-2 w-2">
        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary-400 opacity-75"></span>
        <span class="relative inline-flex rounded-full h-2 w-2 bg-primary-500"></span>
      </span>
    </div>
  </button>
  
  <!-- 歌曲信息提示 - 鼠标悬停时显示 -->
  <div id="song-info" class="absolute right-0 top-full mt-1 bg-white dark:bg-gray-800 rounded-md shadow-lg p-2 text-xs w-48 hidden z-10 transform -translate-x-1/4 opacity-0 transition-all duration-300">
    <div class="flex items-center">
      <div class="flex-shrink-0 w-8 h-8 bg-gray-200 dark:bg-gray-700 rounded overflow-hidden mr-2">
        <div id="song-cover" class="w-full h-full bg-center bg-cover"></div>
      </div>
      <div class="overflow-hidden">
        <div id="song-name" class="font-medium text-gray-900 dark:text-gray-100 truncate"></div>
        <div id="song-artist" class="text-gray-500 dark:text-gray-400 truncate"></div>
      </div>
    </div>
    <div class="mt-1 relative h-1 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
      <div id="song-progress" class="absolute top-0 left-0 h-full bg-primary-500 rounded-full" style="width: 0%"></div>
    </div>
  </div>
  
  <!-- 音频元素 - 仅在全局音频未初始化时使用 -->
  <div id="music-audio-container" style="display:none;"></div>
</div>

<script>
  // ===== 音乐库配置 =====
  // 歌曲库配置
  const musicLibrary = [
    {
      title: "三国杀",
      artist: "未知艺术家",
      src: "/assets/music/三国杀.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "惊月",
      artist: "未知艺术家",
      src: "/assets/music/惊月.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "从未记住的名字永远不会被遗忘",
      artist: "未知艺术家",
      src: "/assets/music/从未记住的名字永远不会被遗忘.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "风月明日来",
      artist: "未知艺术家",
      src: "/assets/music/风月明日来.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "赠你一绸星河 错落人间烟火",
      artist: "未知艺术家",
      src: "/assets/music/赠你一绸星河 错落人间烟火.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "日月星辉之中，你是第四种难得",
      artist: "未知艺术家",
      src: "/assets/music/日月星辉之中，你是第四种难得.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "窗边，淡蓝色与你",
      artist: "未知艺术家",
      src: "/assets/music/窗边，淡蓝色与你.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "春",
      artist: "未知艺术家",
      src: "/assets/music/春.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "半壶纱",
      artist: "未知艺术家",
      src: "/assets/music/半壶纱.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "吹灭小山河",
      artist: "未知艺术家",
      src: "/assets/music/吹灭小山河.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "千灯祈缘",
      artist: "未知艺术家",
      src: "/assets/music/千灯祈缘.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "曦铃",
      artist: "未知艺术家",
      src: "/assets/music/曦铃.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "故里逢春",
      artist: "未知艺术家",
      src: "/assets/music/故里逢春.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "三国恋",
      artist: "未知艺术家",
      src: "/assets/music/三国恋.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "Where Did U Go (G.E.M.重生版)",
      artist: "G.E.M.邓紫棋",
      src: "/assets/music/Where Did U Go (G.E.M.重生版).mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "相思误",
      artist: "未知艺术家",
      src: "/assets/music/相思误.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "影子小姐",
      artist: "未知艺术家",
      src: "/assets/music/影子小姐.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "天龙八部之宿敌",
      artist: "未知艺术家",
      src: "/assets/music/天龙八部之宿敌.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "何日重到苏澜桥",
      artist: "未知艺术家",
      src: "/assets/music/何日重到苏澜桥.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "细雨",
      artist: "未知艺术家",
      src: "/assets/music/细雨.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    },
    {
      title: "山水之间",
      artist: "未知艺术家",
      src: "/assets/music/山水之间.mp3",
      cover: "/assets/music/covers/placeholder.svg"
    }
  ];
  
  // 确保只初始化一次全局音频播放器
  function getGlobalAudio() {
    // 通过使用 sessionStorage 在页面之间共享音频状态
    // 该对象不会在页面导航时丢失
    const GLOBAL_AUDIO_KEY = 'global-music-audio-state';
    
    // 从 sessionStorage 获取当前的播放状态
    function getAudioState() {
      try {
        const state = sessionStorage.getItem(GLOBAL_AUDIO_KEY);
        return state ? JSON.parse(state) : null;
      } catch (e) {
        console.error('无法解析音频状态:', e);
        return null;
      }
    }
    
    // 保存音频状态到 sessionStorage
    function saveAudioState(state) {
      try {
        sessionStorage.setItem(GLOBAL_AUDIO_KEY, JSON.stringify(state));
      } catch (e) {
        console.error('无法保存音频状态:', e);
      }
    }
    
    // 检查全局实例是否已存在
    let globalAudio = window.globalMusicAudio;
    
    if (!globalAudio) {
      console.log("创建全局音频实例");
      // 创建全局音频实例
      globalAudio = new Audio();
      globalAudio.id = 'global-music-audio';
      globalAudio.preload = 'none';
      window.globalMusicAudio = globalAudio;
      
      // 从 sessionStorage 恢复状态
      const storedState = getAudioState();
      if (storedState) {
        globalAudio.src = storedState.src;
        if (storedState.isPlaying) {
          // 尝试恢复播放
          const playPromise = globalAudio.play();
          if (playPromise !== undefined) {
            playPromise.catch(error => {
              console.log("自动恢复播放失败:", error);
            });
          }
        }
        if (storedState.currentTime) {
          globalAudio.currentTime = storedState.currentTime;
        }
      }
      
      // 监听全局音频事件
      globalAudio.addEventListener('ended', () => {
        // 播放结束后，自动播放下一首
        const event = new CustomEvent('music-ended');
        document.dispatchEvent(event);
      });
      
      globalAudio.addEventListener('timeupdate', () => {
        // 更新进度
        const event = new CustomEvent('music-timeupdate');
        document.dispatchEvent(event);
        
        // 定期保存当前播放状态到 sessionStorage (每5秒)
        if (Math.floor(globalAudio.currentTime) % 5 === 0) {
          saveAudioState({
            src: globalAudio.src,
            currentTime: globalAudio.currentTime,
            isPlaying: !globalAudio.paused
          });
        }
      });
      
      globalAudio.addEventListener('play', () => {
        // 更新播放状态
        const event = new CustomEvent('music-state-changed', { detail: { isPlaying: true } });
        document.dispatchEvent(event);
        
        // 保存播放状态
        saveAudioState({
          src: globalAudio.src,
          currentTime: globalAudio.currentTime,
          isPlaying: true
        });
      });
      
      globalAudio.addEventListener('pause', () => {
        // 更新暂停状态
        const event = new CustomEvent('music-state-changed', { detail: { isPlaying: false } });
        document.dispatchEvent(event);
        
        // 保存暂停状态
        saveAudioState({
          src: globalAudio.src,
          currentTime: globalAudio.currentTime,
          isPlaying: false
        });
      });
    }
    
    return globalAudio;
  }
  
  // 页面可见性变化处理 - 在页面切换时保持音乐状态
  document.addEventListener('visibilitychange', () => {
    const globalAudio = window.globalMusicAudio;
    if (!globalAudio) return;
    
    if (document.visibilityState === 'visible') {
      // 页面恢复可见时，如果之前是播放状态，则恢复播放
      const wasPlaying = sessionStorage.getItem('music-was-playing') === 'true';
      if (wasPlaying && globalAudio.paused) {
        globalAudio.play().catch(err => console.log('恢复播放失败:', err));
      }
    } else {
      // 页面不可见时，记录当前播放状态
      sessionStorage.setItem('music-was-playing', !globalAudio.paused);
    }
  });
  
  document.addEventListener('DOMContentLoaded', () => {
    // ===== 获取DOM元素 =====
    const musicToggle = document.getElementById('music-toggle');
    const playIcon = document.getElementById('play-icon');
    const pauseIcon = document.getElementById('pause-icon');
    const musicAnimation = document.getElementById('music-animation');
    const songInfo = document.getElementById('song-info');
    const songName = document.getElementById('song-name');
    const songArtist = document.getElementById('song-artist');
    const songCover = document.getElementById('song-cover');
    const songProgress = document.getElementById('song-progress');
    
    if (!musicToggle) return;
    
    // 获取全局音频实例
    const musicAudio = getGlobalAudio();
    
    // 当前播放的歌曲
    let currentSong = null;
    
    // ===== 核心功能函数 =====
    
    // 随机选择一首歌曲 - 保证完全随机均等概率
    function selectRandomSong() {
      if (musicLibrary.length === 0) return null;
      const randomIndex = Math.floor(Math.random() * musicLibrary.length);
      return musicLibrary[randomIndex];
    }
    
    // 加载并播放歌曲
    function loadAndPlaySong(song) {
      if (!song) return;
      
      currentSong = song;
      musicAudio.src = song.src;
      musicAudio.load();
      
      // 设置歌曲信息
      songName.textContent = song.title;
      songArtist.textContent = song.artist;
      
      // 设置封面图片
      if (song.cover) {
        songCover.style.backgroundImage = `url(${song.cover})`;
      } else {
        songCover.style.backgroundImage = 'none';
      }
      
      // 尝试自动播放
      // 注意：大多数浏览器需要用户交互才能自动播放音频
      const playPromise = musicAudio.play();
      
      if (playPromise !== undefined) {
        playPromise.then(() => {
          // 自动播放成功
          showPauseIcon();
        }).catch(error => {
          // 自动播放失败（大多数浏览器需要用户交互才能播放）
          showPlayIcon();
          console.log("自动播放失败，需要用户交互:", error);
        });
      }
    }
    
    // 显示播放图标
    function showPlayIcon() {
      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');
      musicAnimation.classList.add('hidden');
    }
    
    // 显示暂停图标
    function showPauseIcon() {
      playIcon.classList.add('hidden');
      pauseIcon.classList.remove('hidden');
      musicAnimation.classList.remove('hidden');
    }
    
    // 切换播放/暂停
    function togglePlayPause() {
      if (!currentSong) {
        // 如果没有当前歌曲，随机选择一首并播放
        loadAndPlaySong(selectRandomSong());
        return;
      }
      
      if (musicAudio.paused) {
        musicAudio.play();
      } else {
        musicAudio.pause();
      }
    }
    
    // 更新进度条
    function updateProgress() {
      if (!musicAudio.duration) return;
      const progress = (musicAudio.currentTime / musicAudio.duration) * 100;
      songProgress.style.width = `${progress}%`;
    }
    
    // 显示歌曲信息
    function showSongInfo() {
      if (!currentSong) return;
      songInfo.classList.remove('hidden');
      setTimeout(() => {
        songInfo.classList.remove('opacity-0');
        songInfo.classList.remove('transform');
      }, 10);
    }
    
    // 隐藏歌曲信息
    function hideSongInfo() {
      songInfo.classList.add('opacity-0');
      songInfo.classList.add('transform');
      setTimeout(() => {
        songInfo.classList.add('hidden');
      }, 300);
    }
    
    // 从存储中恢复当前播放状态
    function restorePlayingState() {
      // 从全局音频状态更新UI
      if (musicAudio.paused) {
        showPlayIcon();
      } else {
        showPauseIcon();
      }
      
      // 尝试从 sessionStorage 获取当前播放信息
      try {
        const audioState = sessionStorage.getItem('global-music-audio-state');
        if (audioState) {
          const state = JSON.parse(audioState);
          
          // 查找匹配的歌曲
          if (state.src) {
            const songPath = new URL(state.src, window.location.href).pathname;
            
            // 查找对应的歌曲
            const matchingSong = musicLibrary.find(song => {
              const fullPath = new URL(song.src, window.location.href).pathname;
              return fullPath === songPath;
            });
            
            if (matchingSong) {
              currentSong = matchingSong;
              
              // 更新UI信息
              songName.textContent = currentSong.title;
              songArtist.textContent = currentSong.artist;
              
              if (currentSong.cover) {
                songCover.style.backgroundImage = `url(${currentSong.cover})`;
              } else {
                songCover.style.backgroundImage = 'none';
              }
              
              return; // 已找到匹配歌曲，不需要继续处理
            }
          }
        }
      } catch (e) {
        console.error('恢复播放状态失败:', e);
      }
      
      // 后备方案：尝试从 localStorage 恢复歌曲信息
      const lastSongIndex = localStorage.getItem('music-last-song-index');
      if (lastSongIndex !== null) {
        const index = parseInt(lastSongIndex);
        if (!isNaN(index) && index >= 0 && index < musicLibrary.length) {
          currentSong = musicLibrary[index];
          
          // 只更新UI信息，不重载音频
          if (currentSong) {
            songName.textContent = currentSong.title;
            songArtist.textContent = currentSong.artist;
            
            if (currentSong.cover) {
              songCover.style.backgroundImage = `url(${currentSong.cover})`;
            } else {
              songCover.style.backgroundImage = 'none';
            }
          }
        }
      }
    }
    
    // ===== 初始化 =====
    
    // 初始化
    function init() {
      // 首先恢复UI状态
      restorePlayingState();
      
      // 如果是首次访问或音频源未设置，可能需要初始化播放器
      if (!musicAudio.src) {
        const lastPlayState = localStorage.getItem('music-play-state');
        const lastSongIndex = localStorage.getItem('music-last-song-index');
        
        if (lastPlayState === 'playing' && lastSongIndex !== null) {
          const index = parseInt(lastSongIndex);
          if (!isNaN(index) && index >= 0 && index < musicLibrary.length) {
            loadAndPlaySong(musicLibrary[index]);
          } else {
            // 默认不自动播放，等待用户交互
          }
        }
      }
    }
    
    // 保存播放状态
    function savePlayState() {
      if (!currentSong) return;
      
      const isPlaying = !musicAudio.paused;
      localStorage.setItem('music-play-state', isPlaying ? 'playing' : 'paused');
      
      const songIndex = musicLibrary.findIndex(song => song.title === currentSong.title);
      if (songIndex !== -1) {
        localStorage.setItem('music-last-song-index', songIndex.toString());
      }
    }
    
    // ===== 事件监听 =====
    
    // 点击播放/暂停按钮
    musicToggle.addEventListener('click', togglePlayPause);
    
    // 监听全局音频事件
    document.addEventListener('music-ended', () => {
      // 播放结束后，自动播放下一首随机歌曲
      loadAndPlaySong(selectRandomSong());
    });
    
    document.addEventListener('music-timeupdate', updateProgress);
    
    document.addEventListener('music-state-changed', (e) => {
      if (e.detail.isPlaying) {
        showPauseIcon();
      } else {
        showPlayIcon();
      }
    });
    
    // 鼠标悬停显示歌曲信息
    musicToggle.addEventListener('mouseenter', showSongInfo);
    musicToggle.addEventListener('mouseleave', hideSongInfo);
    
    // 页面关闭前保存状态
    window.addEventListener('beforeunload', savePlayState);
    
    // 初始化
    init();
  });
</script>

<style>
  /* 音乐动画效果 */
  @keyframes musicBounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
  }
</style> 